<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <script src="../js/config.js"></script>
    <script src="../js/util.js"></script>
    <script src="https://cdn.tailwindcss.com/"></script>
    <script defer src="../js/search.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body>
    <header
      class="w-screen flex flex-col items-center px-72"
      x-data="{
        query: (new URL(window.location.href).searchParams.get('query')) ?? '',
        btags: JSON.parse(new URL(window.location.href).searchParams.get('btags')) ?? [],
        tags: false,
        addedTags: JSON.parse(new URL(window.location.href).searchParams.get('tags')) ?? [],
        tquery: '',
        get filteredTags() {
          return (this.tags && this.tquery) ? this.tags.filter(
            i => (i.name.toLowerCase().search(this.tquery.toLowerCase())>=0)&&(this.addedTags.indexOf(i)<0)
          ).slice(0, 50) : []
        }
      }"
      x-init="
        fetchTags().then(json=>{
          tags = json.results;
        })
        if(!btags.length) fetchBTags().then(json=>{
          btags = json.results.map(x=>({...x, value:0.5}));
        })

        "
    >
      <div class="flex flex-row mt-12 w-full">
        <input
          class="rounded-full p-4 pr-24 w-full outline"
          type="text"
          placeholder="ringing future bass snare"
          x-model="query"
          x-on:keyup.enter="submitQuery(query, addedTags, btags)"
        />
        <div
          class="bg-gray-700 rounded-full w-12 h-12 grid place-content-center -ml-14 mt-1 cursor-pointer"
          x-on:click="submitQuery(query, addedTags, btags)"
        >
          <svg
            class="w-8 h-8"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M16.6725 16.6412L21 21M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z"
              stroke="#fff"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </div>
      <div class="flex flex-row flex-wrap-reverse gap-2 p-4 align-start">
        <template x-for="tag in btags" :key="tag.id">
          <div
            class="bg-gray-700 text-white p-1 px-2 font-sm rounded-full text-sm flex flex-row items-center cursor-pointer gap-1"
          >
            <span x-text="tag.name"></span>
            :
            <span x-text="(tag.value * 100).toFixed(0) + '%'"></span>
          </div>
        </template>

        <template x-for="tag in addedTags" :key="tag.id">
          <div
            class="bg-gray-700 text-white p-1 px-2 font-sm rounded-full text-sm flex flex-row items-center cursor-pointer"
            x-on:click="
              //         |                      our greatest nemesis
              //         |                      showed up in my code
              //         |
              //         |                      seldom would such an
              //         |                      acquaintance be seen
              //         |                      and present themself
              //         |                      within a JS function
              //         |
              //         |                      how serendipitous...
              //         |
              //         |                      the line lengths are
              //         |                      a little added bonus
              //         |
              //         |                      use a monospace font
              //        \ /
              //         v
              addedTags.splice(addedTags.indexOf(tag), 1)

              // I literally spent 30 minutes writing a fixed-line-length poem about a company which i hate,
              // and a product which I decided to make an open-source clone of.

              // Instead of actually working on it.

              // That's what I call procrastination.
              
            "
          >
            <span x-text="tag.name"></span>
            <svg
              width="25px"
              height="25px"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M7 17L16.8995 7.10051"
                stroke="#fff"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M7 7.00001L16.8995 16.8995"
                stroke="#fff"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        </template>
      </div>

      <div class="grid grid-cols-2 w-full mt-8 gap-4">
        <div class="flex flex-col items-center">
          <h2 class="text-2xl">Tags</h2>
          <input
            x-model="tquery"
            placeholder="Search here..."
            class="rounded-full p-2 w-full outline m-4"
          />
          <div class="flex flex-row flex-wrap gap-2 p-4 align-start">
            <template x-for="tag in filteredTags" :key="tag.id">
              <div
                class="bg-gray-700 text-white p-1 px-2 font-sm rounded-full text-sm flex flex-row items-center cursor-pointer"
                x-on:click="
                  addedTags.push(tag);
                  tquery = '';
                "
              >
                <span x-text="tag.name"></span>
                <svg
                  class="rotate-45"
                  width="25px"
                  height="25px"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M7 17L16.8995 7.10051"
                    stroke="#fff"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M7 7.00001L16.8995 16.8995"
                    stroke="#fff"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
            </template>
          </div>
        </div>
        <div class="flex flex-col items-center">
          <h2 class="text-2xl">Character</h2>
          <div class="flex flex-row justify-evenly w-full">
            <template x-for="btag in btags" :key="btag.id">
              <div class="flex flex-col items-center">
                <span x-text="btag.name_B"></span>
                <input
                  type="range"
                  orient="vertical"
                  style="
                    writing-mode: vertical-lr;
                    appearance: slider-vertical;
                    direction: rtl;
                    vertical-align: bottom;
                  "
                  x-model="btag.value"
                  min="0"
                  max="1"
                  step="0.01"
                />
                <span x-text="btag.name_A"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
    </header>
    <div
      class="flex flex-col items-center w-full mt-24"
      x-data="{
        samples:[],
        resultCount: 0,
        error: false,
        page: 0,
        hasMore: true,
        pending: false
      }"
    >
      <h2
        class="text-xl text-gray-600"
        x-show="error"
        x-transition
        x-text="error"
      ></h2>

      <div
        x-show="!error"
        x-transition
        class="w-full flex flex-col items-center font-mono"
      >
        <h2 class="self-start text-gray-600 ml-8 w-fit">
          <span x-text="resultCount"></span> samples loaded
        </h2>
        <div class="flex flex-row gap-4 px-8">
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <h2
                x-text="sample.display.name.slice(0, 100)"
                class="p-2 h-10"
              ></h2>
            </template>
          </div>
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <audio
                controls
                x-on:mouseenter="$el.play()"
                x-on:mouseleave="$el.pause()"
                class="h-10"
              >
                <!--                         yeeeeeeee, production-ready code                  -->
                <source
                  x-bind:src="AUDIO_URL+sample.path.replace('#', '%23')"
                  type="audio/ogg"
                />
              </audio>
            </template>
          </div>
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <div class="flex flex-row gap-2 h-10 p-2 align-start">
                <template x-for="tag in sample.display.btags" :key="tag.id">
                  <div
                    class="bg-gray-700 text-white p-1 px-2 font-sm rounded-full text-sm flex flex-row items-center gap-1"
                  >
                    <span x-text="tag.name"></span>
                    :
                    <span x-text="(tag.value * 100).toFixed(0) + '%'"></span>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <a
                x-bind:href="AUDIO_URL+sample.path.replace('#', '%23')"
                class="font-ultralight text-gray-600 h-10 p-2"
                download
                >download</a
              >
            </template>
          </div>
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <a
                x-bind:href="'/similar?id=' + sample._id"
                class="font-ultralight text-gray-600 h-10 p-2"
                >similar</a
              >
            </template>
          </div>
        </div>
      </div>
      <h2
        class="text-xl text-gray-600 p-12 mb-24"
        x-init="
        setInterval(()=>{
        if(isElementInViewport($el) && hasMore && !pending){
          pending = true;
          request(page).then(json=>{
            pending = false;
            if(json.error){
              error = json.error;
              hasMore = false;
            }
            else{
              page += 1
              samples = samples.concat(json.results);
              resultCount += json.resultCount;
              if(json.resultCount == 0) hasMore = false;
            }
          }
        )}}, 200)
      "
      >
        <span x-show="hasMore"> Loading more samples </span>
        <span x-show="!hasMore"> No more samples </span>
      </h2>
    </div>
  </body>
</html>
