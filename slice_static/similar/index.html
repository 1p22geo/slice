<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <script src="../js/config.js"></script>
    <script src="../js/util.js"></script>
    <script src="https://cdn.tailwindcss.com/"></script>
    <script defer src="../js/similar.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body>
    <div
      class="flex flex-col items-center w-full mt-24"
      x-data="{
        samples:[],
        resultCount: 0,
        error: false,
        page: 0,
        hasMore: true,
        pending: false
      }"
    >
      <h2
        class="text-xl text-gray-600"
        x-show="error"
        x-transition
        x-text="error"
      ></h2>

      <div
        x-show="!error"
        x-transition
        class="w-full flex flex-col items-center font-mono"
      >
        <h2 class="self-start text-gray-600 ml-8 w-fit">
          <span x-text="resultCount"></span> samples loaded
        </h2>
        <div class="flex flex-row gap-4 px-8">
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <h2
                x-text="sample.display.name.slice(0, 100)"
                class="p-2 h-10"
              ></h2>
            </template>
          </div>
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <audio
                controls
                x-on:mouseenter="$el.play()"
                x-on:mouseleave="$el.pause()"
                class="h-10"
              >
                <!--                         yeeeeeeee, production-ready code                  -->
                <source
                  x-bind:src="AUDIO_URL+sample.path.replace('#', '%23')"
                  type="audio/ogg"
                />
              </audio>
            </template>
          </div>
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <div class="flex flex-row gap-2 h-10 p-2 align-start">
                <template x-for="tag in sample.display.btags" :key="tag.id">
                  <div
                    class="bg-gray-700 text-white p-1 px-2 font-sm rounded-full text-sm flex flex-row items-center gap-1"
                  >
                    <span x-text="tag.name"></span>
                    :
                    <span x-text="(tag.value * 100).toFixed(0) + '%'"></span>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <a
                x-bind:href="AUDIO_URL+sample.path.replace('#', '%23')"
                class="font-ultralight text-gray-600 h-10 p-2"
                download
                >download</a
              >
            </template>
          </div>
          <div class="flex flex-col items-left">
            <template x-for="sample in samples">
              <a
                x-bind:href="'/similar?id=' + sample._id"
                class="font-ultralight text-gray-600 h-10 p-2"
                >similar</a
              >
            </template>
          </div>
        </div>
      </div>
      <h2
        class="text-xl text-gray-600 p-12 mb-24"
        id="loading"
        x-init="
        setInterval(()=>{
        if(isElementInViewport($el) && hasMore && !pending){
          pending = true;
          request(page).then(json=>{
            pending = false;
            if(json.error){
              error = json.error;
              hasMore = false;
            }
            else{
              page += 1
              samples = samples.concat(json.results);
              resultCount += json.resultCount;
              if(json.resultCount == 0) hasMore = false;
            }
          }
        )}}, 200)
      "
      >
        Loading more samples
      </h2>
    </div>
  </body>
</html>
